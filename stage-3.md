# Stage 3: Integrating OS builds into your CI/CD pipelines

Docs:
  - [Kairos Factory Action ðŸ­](https://github.com/kairos-io/kairos-factory-action/)
  - [Example repository](https://github.com/jimmykarily/kairos-wireguard)

## Create a GitHub repository

Go to: https://github.com/new and create a new repository under your account.

Follow the instructions to clone the repository locally.

## Create a simple release pipeline

```bash

mkdir -p .github/workflows/

cat > .github/workflows/release.yaml <<EOF
name: Build Kairos WireGuard Image

on:
  push:
    tags:
      - '*'
  release:
    types: [created]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      base_image_tag: ${{ steps.extract.outputs.base_tag }}
      combined_tag: ${{ steps.extract.outputs.combined_tag }}
      git_tag: ${{ steps.extract.outputs.git_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract tags and combine
        id: extract
        run: |
          # Get git tag
          if [ "${{ github.event_name }}" == "release" ]; then
            GIT_TAG="${{ github.event.release.tag_name }}"
          else
            GIT_TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Extract the KAIROS_BASE_IMAGE line from Dockerfile
          BASE_IMAGE_LINE=$(grep "^ARG KAIROS_BASE_IMAGE=" Dockerfile | head -1)
          FULL_IMAGE=$(echo "$BASE_IMAGE_LINE" | sed 's/.*=//' | tr -d '"')
          BASE_TAG=$(echo "$FULL_IMAGE" | cut -d':' -f2)

          # Combine tags: git_tag-base_tag
          COMBINED_TAG="${GIT_TAG}-${BASE_TAG}"

          echo "git_tag=$GIT_TAG" >> $GITHUB_OUTPUT
          echo "base_tag=$BASE_TAG" >> $GITHUB_OUTPUT
          echo "combined_tag=$COMBINED_TAG" >> $GITHUB_OUTPUT
          echo "Git tag: $GIT_TAG"
          echo "Base image tag: $BASE_TAG"
          echo "Combined tag: $COMBINED_TAG"

  build:
    needs: prepare
    permissions:
      id-token: write
      contents: write
      actions: read
      security-events: write
    uses: kairos-io/kairos-factory-action/.github/workflows/reusable-factory.yaml@main
    secrets:
      registry_username: ${{ secrets.QUAY_USERNAME }}
      registry_password: ${{ secrets.QUAY_PASSWORD }}
    with:
      dockerfile_path: Dockerfile
      base_image: ubuntu:24.04
      model: generic
      arch: amd64
      kubernetes_distro: k3s
      kubernetes_version: auto
      version: auto
      trusted_boot: false
      no_cache: false
      iso: false
      raw: false
      vhd: false
      gce: false
      tar: false
      compute_checksums: true
      output_format: auto
      security_checks: ""
      cosign: false
      grype: false
      trivy: false
      grype_sarif: false
      trivy_sarif: false
      registry_domain: quay.io
      registry_namespace: jimmykarily
      registry_repository: kairos-wireguard
      custom_tag_format: ${{ needs.prepare.outputs.combined_tag }}
      summary_artifacts: false
      auroraboot_version: latest
      release: false
      list_release_artifacts: false

  build-iso:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Pull container image
        run: |
          CONTAINER_IMAGE="quay.io/jimmykarily/kairos-wireguard:${{ needs.prepare.outputs.combined_tag }}"
          echo "Pulling container image: $CONTAINER_IMAGE"
          docker pull "$CONTAINER_IMAGE"

      - name: Generate ISO with auroraboot
        run: |
          CONTAINER_IMAGE="quay.io/jimmykarily/kairos-wireguard:${{ needs.prepare.outputs.combined_tag }}"
          echo "Generating ISO from container image: $CONTAINER_IMAGE"

          docker run -v /var/run/docker.sock:/var/run/docker.sock --net host \
            --privileged \
            -v $PWD:/aurora --rm quay.io/kairos/auroraboot:latest \
            --debug \
            --set "disable_http_server=true" \
            --set "container_image=docker:${CONTAINER_IMAGE}" \
            --set "disable_netboot=true" \
            --set "disk.iso=true" \
            --set "state_dir=/aurora"

      - name: Rename ISO with combined tag
        run: |
          # Find the ISO file generated by auroraboot
          ISO_FILE=$(ls *.iso 2>/dev/null | head -1)
          if [ -z "$ISO_FILE" ]; then
            echo "Error: No ISO file found. Listing files:"
            ls -la
            exit 1
          fi
          # Ensure the new name has .iso extension
          NEW_NAME="kairos-wireguard-${{ needs.prepare.outputs.combined_tag }}.iso"
          mv "$ISO_FILE" "$NEW_NAME"
          echo "Renamed ISO from $ISO_FILE to $NEW_NAME"
          ls -lh "$NEW_NAME"

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.git_tag }}
          name: Release ${{ needs.prepare.outputs.git_tag }}
          draft: false
          prerelease: false
          files: "kairos-wireguard-*.iso"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
EOF

# Push the changed
git add .
git commit -m "Add pipeline"
git push origin main
```

## Trigger a build

```bash
git tag v0.0.1
git push origin v0.0.1
```

Check the build output:

https://github.com/<your_account>/<your_repo>/actions

## Use the artifact

Visit the releases page of your repository and download the built ISO. Then
follow the instructions of [stage-1](stage-1.md) to create a virtual machine for
the this ISO.

âœ… Done! ðŸŽ‰
